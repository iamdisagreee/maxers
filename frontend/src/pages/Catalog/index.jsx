import React, { useEffect, useState } from 'react';
import './Catalog.css'
import TaskCard from '../../components/TaskCard';
import { useTaskOpener } from '../../contexts/TaskOpenerContext';
import { getAllTasks } from '../../api/tasks';
import TaskCreate from '..//../components/TaskCreate'
// import TaskPage from '../../components/TaskPage';

export default function Home({ profile, role, token }) {
  const [tasks, setTasks] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const isHelper = role === 'Helper';
  const isNeedy = role === 'Needy';
  const { open } = useTaskOpener();

  useEffect(() => {
    const fetchTasks = async () => {
      setLoading(true);
      setError(null);
      try {
        // Helper: 'user', Needy: 'pending'
        const typeList = isHelper ? 'user' : 'pending';
        const data = await getAllTasks(token, 1, typeList);
        setTasks(data || []);
      } catch (err) {
        console.error('Failed to fetch tasks:', err);
        setError('Не удалось загрузить задачи');
      } finally {
        setLoading(false);
      }
    };

    if (role) fetchTasks();
  }, [role]);

const handleClick = () => {
  open(
    <TaskCreate
      onComplete={() => {
        console.log("задача выполнена!");
        // можно обновить список задач
      }}
    />
  );
};

  // Заглушки для пустого состояния
  const renderEmptyState = () => {
    if (isHelper) {
      return <div className="tasks-empty">
        <svg className="tasks-empty-svg" width="45" height="42" viewBox="0 0 45 42" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M22.5009 17.3243C27.4929 12.3053 39.9759 21.0863 22.5009 32.3783C5.02593 21.0863 17.5089 12.3053 22.5009 17.3243Z" stroke="url(#paint0_linear_197_531)" stroke-opacity="0.45" stroke-width="3"/>
          <path d="M24.6218 0.878359C24.0593 0.315946 23.2963 0 22.5008 0C21.7053 0 20.9424 0.315946 20.3798 0.878359L0.438835 20.8164C0.157573 21.098 -0.000280929 21.4799 3.75332e-07 21.8779C0.00028168 22.276 0.158675 22.6576 0.440334 22.9389C0.721994 23.2201 1.10385 23.378 1.5019 23.3777C1.89994 23.3774 2.28157 23.219 2.56283 22.9374L4.50083 20.9994V36.8784C4.50083 38.0718 4.97494 39.2164 5.81885 40.0603C6.66277 40.9043 7.80736 41.3784 9.00083 41.3784H36.0008C37.1943 41.3784 38.3389 40.9043 39.1828 40.0603C40.0267 39.2164 40.5008 38.0718 40.5008 36.8784V20.9994L42.4388 22.9374C42.7201 23.219 43.1017 23.3774 43.4998 23.3777C43.8978 23.378 44.2797 23.2201 44.5613 22.9389C44.843 22.6576 45.0014 22.276 45.0017 21.8779C45.002 21.4799 44.8441 21.098 44.5628 20.8164L37.5008 13.7574V3.87836C37.5008 3.48053 37.3428 3.099 37.0615 2.8177C36.7802 2.53639 36.3987 2.37836 36.0008 2.37836H33.0008C32.603 2.37836 32.2215 2.53639 31.9402 2.8177C31.6589 3.099 31.5008 3.48053 31.5008 3.87836V7.75736L24.6218 0.878359ZM37.5008 17.9994V36.8784C37.5008 37.2762 37.3428 37.6577 37.0615 37.939C36.7802 38.2203 36.3987 38.3784 36.0008 38.3784H9.00083C8.60301 38.3784 8.22148 38.2203 7.94018 37.939C7.65887 37.6577 7.50083 37.2762 7.50083 36.8784V17.9994L22.5008 2.99936L37.5008 17.9994Z" fill="url(#paint1_linear_197_531)" fill-opacity="0.45"/>
          <defs>
          <linearGradient id="paint0_linear_197_531" x1="13.5017" y1="24.1284" x2="31.5002" y2="24.1284" gradientUnits="userSpaceOnUse">
          <stop stop-color="#8EA9E8"/>
          <stop offset="1" stop-color="#505F82"/>
          </linearGradient>
          <linearGradient id="paint1_linear_197_531" x1="0" y1="20.6892" x2="45.0017" y2="20.6892" gradientUnits="userSpaceOnUse">
          <stop stop-color="#8EA9E8"/>
          <stop offset="1" stop-color="#505F82"/>
          </linearGradient>
          </defs>
          <script xmlns=""/>
        </svg>
        <h4 className="tasks-empty-h tasks-empty-text inter-700 h4">Пока тихо</h4>
        <h3 className="tasks-empty-h2 tasks-empty-text h5 inter-700">Это хорошая новость — значит, прямо сейчас никому поблизости не нужна помощь.<br></br>Спасибо, что вы здесь и готовы помогать!</h3>
        <span className="tasks-empty-span tasks-empty-text h5 inter-600">Загляните чуть позже, возможно, появится новое задание</span>
      </div>;
    }
    if (isNeedy) {
      return <div className="tasks-empty">
        <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
          <g clip-path="url(#clip0_227_1335)">
          <path d="M42.96 26.7469C42.4464 26.3513 41.8483 26.0798 41.2124 25.9536C40.5766 25.8274 39.9201 25.85 39.2944 26.0194L38.4844 26.2069C42.5625 22.4157 44.625 18.6582 44.625 15C44.625 10.245 40.8019 6.37505 36.1012 6.37505C34.7756 6.36674 33.4662 6.66742 32.277 7.25325C31.0877 7.83908 30.0513 8.69395 29.25 9.75005C28.4487 8.69395 27.4123 7.83908 26.223 7.25325C25.0338 6.66742 23.7244 6.36674 22.3988 6.37505C17.6981 6.37505 13.875 10.245 13.875 15C13.875 17.1338 14.5556 19.2169 15.9919 21.4425C14.8146 21.6241 13.7264 22.1781 12.8869 23.0232L8.535 27.375H3C2.30381 27.375 1.63613 27.6516 1.14384 28.1439C0.651562 28.6362 0.375 29.3039 0.375 30V37.5C0.375 38.1962 0.651562 38.8639 1.14384 39.3562C1.63613 39.8485 2.30381 40.125 3 40.125H22.5C22.5923 40.1251 22.6842 40.1137 22.7738 40.0913L34.7738 37.0913C34.8306 37.0763 34.8863 37.0575 34.9406 37.035L42.2194 33.9375L42.2812 33.9094C42.9248 33.588 43.476 33.1081 43.8828 32.5148C44.2896 31.9216 44.5387 31.2345 44.6066 30.5183C44.6745 29.8022 44.559 29.0806 44.2709 28.4214C43.9828 27.7623 43.5317 27.1873 42.96 26.7507V26.7469ZM22.3988 8.62505C23.636 8.60854 24.85 8.96157 25.8855 9.63896C26.921 10.3164 27.7307 11.2873 28.2113 12.4275C28.296 12.6339 28.4402 12.8104 28.6255 12.9346C28.8108 13.0588 29.0288 13.1251 29.2519 13.1251C29.4749 13.1251 29.693 13.0588 29.8783 12.9346C30.0636 12.8104 30.2077 12.6339 30.2925 12.4275C30.773 11.2873 31.5828 10.3164 32.6183 9.63896C33.6537 8.96157 34.8678 8.60854 36.105 8.62505C39.5025 8.62505 42.375 11.5444 42.375 15C42.375 18.795 39.3412 23.0625 33.6 27.3282L30.8119 27.9694C31.0899 27.2317 31.1849 26.4375 31.0887 25.655C30.9925 24.8725 30.7079 24.125 30.2593 23.4766C29.8108 22.8282 29.2117 22.2983 28.5134 21.9322C27.8151 21.5662 27.0384 21.375 26.25 21.375H18.6881C16.9425 19.0632 16.125 17.0269 16.125 15C16.125 11.5444 18.9975 8.62505 22.3988 8.62505ZM2.625 37.5V30C2.625 29.9006 2.66451 29.8052 2.73484 29.7349C2.80516 29.6646 2.90054 29.625 3 29.625H7.875V37.875H3C2.90054 37.875 2.80516 37.8355 2.73484 37.7652C2.66451 37.6949 2.625 37.5995 2.625 37.5ZM41.3025 31.875L34.14 34.9257L22.3612 37.875H10.125V28.9669L14.4769 24.6132C14.7896 24.2988 15.1616 24.0496 15.5713 23.88C15.981 23.7104 16.4203 23.6237 16.8638 23.625H26.25C26.9462 23.625 27.6139 23.9016 28.1062 24.3939C28.5984 24.8862 28.875 25.5539 28.875 26.25C28.875 26.9462 28.5984 27.6139 28.1062 28.1062C27.6139 28.5985 26.9462 28.875 26.25 28.875H21C20.7016 28.875 20.4155 28.9936 20.2045 29.2045C19.9935 29.4155 19.875 29.7017 19.875 30C19.875 30.2984 19.9935 30.5846 20.2045 30.7955C20.4155 31.0065 20.7016 31.125 21 31.125H27C27.0845 31.1251 27.1688 31.1157 27.2512 31.0969L39.8138 28.2075L39.8587 28.1963C40.3316 28.0674 40.8354 28.1177 41.2733 28.3376C41.7113 28.5575 42.0526 28.9315 42.2316 29.3877C42.4107 29.8439 42.4148 30.3502 42.2434 30.8093C42.0719 31.2684 41.7368 31.6479 41.3025 31.875Z" fill="#A8D8B9" stroke="#A8D8B9"/>
          </g>
          <defs>
          <clipPath id="clip0_227_1335">
          <rect width="48" height="48" fill="white"/>
          </clipPath>
          </defs>
          <script xmlns=""/>
        </svg>
        <h4 className="tasks-empty-h tasks-empty-text inter-700 h4">Нужна помощь?</h4>
        <h3 className="tasks-empty-h2 tasks-empty-text h5 inter-700">Не стесняйтесь просить!<br></br>Ваша просьба появится здесь, и кто-то рядом обязательно откликнется</h3>
        <span className="tasks-empty-span tasks-empty-text h6 inter-600">Нажмите на плюсик внизу, чтобы создать первое задание</span>
        <svg width="36" height="100" viewBox="0 0 36 100" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15.025 1.66896C15.3945 1.25845 15.3612 0.626163 14.9507 0.256705C14.5402 -0.112754 13.9079 -0.0794742 13.5384 0.331036L14.2817 1L15.025 1.66896ZM35.2816 100L32.2937 88.8463L24.1283 97.0108L35.2816 100ZM14.2817 1L13.5384 0.331036C2.7468 12.3218 -1.72585 27.2654 0.598674 43.5135C2.91939 59.7349 12.0021 77.1932 28.194 94.3253L28.9207 93.6384L29.6475 92.9515C13.6506 76.0257 4.8247 58.9307 2.57851 43.2302C0.33614 27.5564 4.63834 13.2097 15.025 1.66896L14.2817 1Z" fill="#C4C4C4"/>
          <script xmlns=""/>
        </svg>
      </div>;
    }
    return null;
  };

  return (
    <div>
      {isNeedy && (
        <div className="add-task-btn gradient-primary-bg color-white" onClick={handleClick}>+</div>
      )}

      <div className="catalog-h">
        <h1 className='h1 inter-700 gradient-primary'>
          {isHelper ? 'Каталог' : isNeedy ? 'Мои просьбы' : 'Главная'}
        </h1>
      </div>

      <div className='tasks-wrapper'>
        {loading && <div className="tasks-loading">Загрузка...</div>}

        {!loading && error && (
          <div className="tasks-error">{error}</div>
        )}

        {!loading && !error && tasks.length === 0 && renderEmptyState()}

        {!loading && !error && tasks.length > 0 && tasks.map(task => (
          <TaskCard key={task.id} task={task} type={role} />
        ))}
      </div>
    </div>
  )
}
